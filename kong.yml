_format_version: "3.0"

plugins:
  - name: rate-limiting
    config:
      second: 10
      limit_by: ip
      policy: local

  - name: pre-function
    service: todo-grpc-service
    config: {}

consumers: 
  - username: todo-app-user
    jwt_secrets:
      - key: todo-app-issuer
        secret: your-secret-key-here
        algorithm: HS256
  - username: anonymous-user

services:
  - name: todo-grpc-service
    url: grpc://todo-grpc-app:50051

routes:
  - name: auth-login
    paths:
      - /auth/login
    methods:
      - POST
    protocols:
      - http
    service: todo-grpc-service
    plugins:
      - name: grpc-transcode
        config:
          proto: /usr/local/kong/include/src/api/todo.proto
          service: TodoService
          method: Login
      - name: rate-limiting
        config:
          second: 5
          limit_by: ip
          policy: local

  - name: auth-register
    paths:
      - /auth/register
    methods:
      - POST
    protocols:
      - http
    service: todo-grpc-service
    plugins:
      - name: grpc-transcode
        config:
          proto: /usr/local/kong/include/src/api/todo.proto
          service: TodoService
          method: Register
      - name: rate-limiting
        config:
          second: 5
          limit_by: ip
          policy: local

  - name: get-all-todos
    paths:
      - /todos
    methods:
      - GET
    protocols:
      - http
    service: todo-grpc-service
    plugins:
      - name: grpc-transcode
        config:
          proto: /usr/local/kong/include/src/api/todo.proto
          service: TodoService
          method: GetAllTodos
      - name: jwt
        config:
          uri_param_names:
            - jwt
          cookie_names:
            - jwt
          header_names:
            - authorization
          claims_to_verify:
            - exp
          key_claim_name: iss
          secret_is_base64: false
          anonymous: null
          run_on_preflight: true
      - name: rate-limiting
        config:
          second: 3
          limit_by: ip
          policy: local

  - name: get-todo
    paths:
      - /todos/(?<id>\d+)
    methods:
      - GET
    protocols:
      - http
    service: todo-grpc-service
    plugins:
      - name: grpc-transcode
        config:
          proto: /usr/local/kong/include/src/api/todo.proto
          service: TodoService
          method: GetTodo
      - name: jwt
        config:
          uri_param_names:
            - jwt
          cookie_names:
            - jwt
          header_names:
            - authorization
          claims_to_verify:
            - exp
          key_claim_name: iss
          secret_is_base64: false
          anonymous: null
          run_on_preflight: true
      - name: rate-limiting
        config:
          second: 5
          limit_by: ip
          policy: local
      - name: pre-function


  - name: create-todo
    paths:
      - /todos
    methods:
      - POST
    protocols:
      - http
    service: todo-grpc-service
    plugins:
      - name: grpc-transcode
        config:
          proto: /usr/local/kong/include/src/api/todo.proto
          service: TodoService
          method: CreateTodo
      - name: jwt
        config:
          uri_param_names:
            - jwt
          cookie_names:
            - jwt
          header_names:
            - authorization
          claims_to_verify:
            - exp
          key_claim_name: iss
          secret_is_base64: false
          anonymous: null
          run_on_preflight: true
      - name: rate-limiting
        config:
          second: 2
          limit_by: ip
          policy: local

  - name: update-todo
    paths:
      - /todos/(?<id>\d+)
    strip_path: false
    methods:
      - PUT
    protocols:
      - http
    service: todo-grpc-service
    plugins:
      - name: grpc-transcode
        config:
          proto: /usr/local/kong/include/src/api/todo.proto
          service: TodoService
          method: UpdateTodo
      - name: jwt
        config:
          uri_param_names:
            - jwt
          cookie_names:
            - jwt
          header_names:
            - authorization
          claims_to_verify:
            - exp
          key_claim_name: iss
          secret_is_base64: false
          anonymous: null
          run_on_preflight: true
      - name: rate-limiting
        config:
          second: 3
          limit_by: ip
          policy: local

  - name: delete-todo
    paths:
      - /todos/(?<id>\d+)
    strip_path: false
    methods:
      - DELETE
    protocols:
      - http
    service: todo-grpc-service
    plugins:
      - name: grpc-transcode
        config:
          proto: /usr/local/kong/include/src/api/todo.proto
          service: TodoService
          method: DeleteTodo
      - name: jwt
        config:
          uri_param_names:
            - jwt
          cookie_names:
            - jwt
          header_names:
            - authorization
          claims_to_verify:
            - exp
          key_claim_name: iss
          secret_is_base64: false
          anonymous: null
          run_on_preflight: true
      - name: rate-limiting
        config:
          second: 1
          limit_by: ip
          policy: local

  - name: complete-todo
    paths:
      - ~/todos/(?<id>\d+)/complete$
    strip_path: false
    methods:
      - POST
    protocols:
      - http
    service: todo-grpc-service
    plugins:
      - name: grpc-transcode
        config:
          proto: /usr/local/kong/include/src/api/todo.proto
          service: TodoService
          method: CompleteTodo
      - name: jwt
        config:
          uri_param_names:
            - jwt
          cookie_names:
            - jwt
          header_names:
            - authorization
          claims_to_verify:
            - exp
          key_claim_name: iss
          secret_is_base64: false
          anonymous: null
          run_on_preflight: true
      - name: rate-limiting
        config:
          second: 5
          limit_by: ip
          policy: local